name: Download Docker & CentOS System Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 1 * *'  # æ¯æœˆ1å· 01:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  CENTOS_VERSION: 9  # CentOS 9 Stream
  TARGET_DIR: deps          # ç»Ÿä¸€è§£å‹ç›®æ ‡ç›®å½•
  ARCH: x86_64              # CentOS æ¶æ„ï¼ˆx86_64 å¯¹åº” amd64ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest  # ä»å¯ä½¿ç”¨ Ubuntu  runnerï¼Œé€šè¿‡å·¥å…·ä¸‹è½½ CentOS åŒ…
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends \
            curl jq gzip libxml2-utils  # libxml2-utils ç”¨äºè§£æ CentOS ä»“åº“ XML

      # ----------------------------
      # Step 1: ä¸‹è½½ Docker ç»„ä»¶ (rpm åŒ…)
      # ----------------------------
      - name: è·å– Docker åŒ…æœ€æ–°ä¸‹è½½é“¾æ¥
        id: package_urls
        run: |
          set -euo pipefail
          # CentOS Docker å®˜æ–¹ä»“åº“åœ°å€
          BASE_URL="https://download.docker.com/linux/centos/${CENTOS_VERSION}/${ARCH}/stable/Packages"
          
          # è·å–ä»“åº“é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$BASE_URL/" | tr -d '\r')
          echo "rpmUG: Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # æå–æŒ‡å®šåŒ…çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆrpm æ ¼å¼ï¼‰
          get_latest() {
            local pkg="$1"
            # åŒ¹é… rpm åŒ…æ–‡ä»¶åæ ¼å¼
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "${pkg}" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No package found for ${pkg}" >&2
              return 1
            fi
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºå¹¶å–æœ€æ–°ç‰ˆæœ¬
            echo "$matches" | sort -Vr | head -n1
          }

          # è·å–å„ Docker ç»„ä»¶æœ€æ–°åŒ…
          CONTAINERD=$(get_latest "containerd.io") || exit 1
          DOCKER_CE=$(get_latest "docker-ce") || exit 1
          CLI=$(get_latest "docker-ce-cli") || exit 1
          BUILDX_PLUGIN=$(get_latest "docker-buildx-plugin") || exit 1
          COMPOSE_PLUGIN=$(get_latest "docker-compose-plugin") || exit 1

          # è¾“å‡ºå®Œæ•´ä¸‹è½½é“¾æ¥
          echo "CONTAINERD_URL=${BASE_URL}/${CONTAINERD}" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=${BASE_URL}/${DOCKER_CE}" >> $GITHUB_OUTPUT
          echo "CLI_URL=${BASE_URL}/${CLI}" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=${BASE_URL}/${BUILDX_PLUGIN}" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=${BASE_URL}/${COMPOSE_PLUGIN}" >> $GITHUB_OUTPUT

          # è°ƒè¯•è¾“å‡º
          echo "rpmUG: æ‰¾åˆ°çš„ Docker åŒ…:"
          echo "Containerd: $CONTAINERD"
          echo "Docker CE: $DOCKER_CE"
          echo "CLI: $CLI"
          echo "Buildx: $BUILDX_PLUGIN"
          echo "Compose: $COMPOSE_PLUGIN"

      - name: ä¸‹è½½ Docker ç»„ä»¶
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/deps"
          
          # ä¸‹è½½æ‰€æœ‰ Docker ç»„ä»¶ï¼ˆä¿å­˜ä¸º rpm åŒ…ï¼‰
          curl -fsSL "${{ steps.package_urls.outputs.CONTAINERD_URL }}" -o "$TARGET_DIR/deps/containerd.rpm"
          curl -fsSL "${{ steps.package_urls.outputs.DOCKER_CE_URL }}" -o "$TARGET_DIR/deps/docker-ce.rpm"
          curl -fsSL "${{ steps.package_urls.outputs.CLI_URL }}" -o "$TARGET_DIR/deps/docker-ce-cli.rpm"
          curl -fsSL "${{ steps.package_urls.outputs.BUILDX_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-buildx-plugin.rpm"
          curl -fsSL "${{ steps.package_urls.outputs.COMPOSE_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-compose-plugin.rpm"

      - name: éªŒè¯ Docker åŒ…
        run: |
          echo "Docker åŒ…åˆ—è¡¨:"
          ls -l "$TARGET_DIR/deps/"
          echo -e "\nDocker åŒ…ç‰ˆæœ¬ä¿¡æ¯:"
          for rpm in "$TARGET_DIR/deps"/*.rpm; do
            rpm -qpi "$rpm" | grep -E "Name|Version|Release"
            echo "------------------------"
          done

      # ----------------------------
      # Step 2: ä¸‹è½½ CentOS ç³»ç»ŸåŒ… (rpm åŒ…)
      # ----------------------------
      - name: å®šä¹‰éœ€è¦ä¸‹è½½çš„ç³»ç»ŸåŒ…
        run: |
          # CentOS 9 å¿…éœ€çš„ç³»ç»Ÿä¾èµ–åŒ…
          echo "SYSTEM_PACKAGES=libseccomp fuse3-libs fuse-overlayfs slirp4netns" >> $GITHUB_ENV

      - name: ä¸‹è½½ CentOS ç³»ç»ŸåŒ…
        run: |
          set -euo pipefail
          packages=(${SYSTEM_PACKAGES// / })
          # CentOS 9 å®˜æ–¹ä»“åº“ï¼ˆBaseOS å’Œ AppStreamï¼‰
          REPOS=("Packages" "AppStream")

          get_latest1() {
            local pkg="$1"
            # åŒ¹é… rpm åŒ…æ–‡ä»¶åæ ¼å¼
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "${pkg}" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No package found for ${pkg}" >&2
              return 1
            fi
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºå¹¶å–æœ€æ–°ç‰ˆæœ¬
            echo "$matches" | sort -Vr | head -n1
          }
          
          for repo in "${REPOS[@]}"; do
            echo -e "\nå°è¯•ä»ä»“åº“: $repo ä¸‹è½½"
            REPO_URL="https://mirror.centos.org/centos/9-stream/${repo}/x86_64/os/"

            
             repo_xml=$(get_latest1 "primary.xml.gz") || exit 1
            
            
            # ä¸‹è½½ä»“åº“å…ƒæ•°æ®ï¼ˆprimary.xml.gzï¼ŒåŒ…å«æ‰€æœ‰åŒ…ä¿¡æ¯ï¼‰
            if ! curl -fsSL ${repo_xml} -o primary.xml.gz; then
              echo "WARNING: æ— æ³•ä¸‹è½½ $repo çš„å…ƒæ•°æ®"
              continue
            fi
            
            # è§£å‹å…ƒæ•°æ®
            gunzip -f primary.xml.gz || { echo "WARNING: è§£å‹å…ƒæ•°æ®å¤±è´¥"; rm -f primary.xml; continue; }
            
            # è§£æ XML å¹¶ä¸‹è½½ç›®æ ‡åŒ…
            for pkg in "${packages[@]}"; do
              # è·³è¿‡å·²ä¸‹è½½çš„åŒ…
              [ -f "$TARGET_DIR/deps/$pkg.rpm" ] && continue
              
              # ç”¨ xmllint è§£æåŒ…çš„ä¸‹è½½è·¯å¾„ï¼ˆCentOS ä»“åº“å…ƒæ•°æ®ä¸º XML æ ¼å¼ï¼‰
              LOCATION=$(xmllint --xpath \
                "string(//rpm:package[rpm:name='$pkg']/rpm:location/@href)" \
                primary.xml 2>/dev/null)
              
              if [ -n "$LOCATION" ]; then
                FILE_URL="$REPO_URL/$LOCATION"
                echo "ä¸‹è½½ $pkg: $FILE_URL"
                if curl -fsSL "$FILE_URL" -o "$TARGET_DIR/deps/$pkg.rpm"; then
                  echo "æˆåŠŸä¸‹è½½ $pkg"
                else
                  echo "WARNING: ä¸‹è½½ $pkg å¤±è´¥"
                fi
              fi
            done
            
            rm -f primary.xml
          done

          # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŒ…éƒ½ä¸‹è½½æˆåŠŸ
          missing_packages=()
          for pkg in "${packages[@]}"; do
            if [ ! -f "$TARGET_DIR/deps/$pkg.rpm" ]; then
              missing_packages+=("$pkg")
            fi
          done
          
          if [ ${#missing_packages[@]} -ne 0 ]; then
            echo -e "\nERROR: ä»¥ä¸‹åŒ…æœªæ‰¾åˆ°: ${missing_packages[*]}" >&2
            exit 1
          fi

          echo -e "\næ‰€æœ‰ç³»ç»ŸåŒ…ä¸‹è½½å®Œæˆ:"
          ls -l "$TARGET_DIR/deps/"

      # ----------------------------
      # Step 3: åˆå¹¶æ–‡ä»¶å¹¶å‹ç¼©
      # ----------------------------
      - name: æ·»åŠ  CentOS å®‰è£…è„šæœ¬
        run: |
          set -euo pipefail
          # ç¡®ä¿ä»“åº“æ ¹ç›®å½•æœ‰ CentOS é€‚é…çš„å®‰è£…è„šæœ¬ï¼ˆéœ€è‡ªè¡Œåˆ›å»º centos-install.shï¼‰
          if [ ! -f "centos-install.sh" ]; then
            echo "ERROR: æœªæ‰¾åˆ° CentOS å®‰è£…è„šæœ¬ centos-install.sh" >&2
            exit 1
          fi
          # å¤åˆ¶è„šæœ¬åˆ°ç›®æ ‡ç›®å½•å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          cp centos-install.sh "$TARGET_DIR/deps/install.sh"
          chmod +x "$TARGET_DIR/deps/install.sh"
          echo "å·²æ·»åŠ å®‰è£…è„šæœ¬: install.sh"

      - name: å‹ç¼©æ‰€æœ‰æ–‡ä»¶
        run: |
          set -euo pipefail
          cd "$TARGET_DIR"
          # å‹ç¼© deps ç›®å½•ä¸º deps.tar.gz
          tar -czvf deps.tar.gz deps
          echo -e "\nå‹ç¼©å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨:"
          tar -tf deps.tar.gz

      # ----------------------------
      # Step 4: ä¸Šä¼ åˆ¶å“
      # ----------------------------
      - name: ä¸Šä¼ ç¦»çº¿åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: centos-9-docker-system-deps
          path: "${{ env.TARGET_DIR }}/deps.tar.gz"
          retention-days: 30  # ä¿ç•™ 30 å¤©

      # ----------------------------
      # Step 5: åˆ›å»º Releaseï¼ˆå¯é€‰ï¼‰
      # ----------------------------
      - name: ç”Ÿæˆ Release æ ‡ç­¾
        id: generate_tag
        run: |
          RELEASE_TAG="centos-9-deps-$(date +'%Y%m%d')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: CentOS 9 Docker + ç³»ç»Ÿä¾èµ– (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            - Docker CE å…¨å®¶æ¡¶ (containerd.io, docker-ce, docker-ce-cli, buildx, compose)
            - CentOS 9 ç³»ç»Ÿä¾èµ– (libseccomp, fuse3-libs, fuse-overlayfs, slirp4netns)
            - ä¸€é”®å®‰è£…è„šæœ¬ (install.sh)
            
            æ”¯æŒæ¶æ„: x86_64
            æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: "${{ env.TARGET_DIR }}/deps.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      # ----------------------------
      # Step 6: æ¸…ç†
      # ----------------------------
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf "$TARGET_DIR"
          rm -f primary.xml.gz primary.xml
