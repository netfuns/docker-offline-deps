name: Build & Release OracleLinux9 Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 1 * *' # æ¯æœˆ1å· 01:00 UTC è‡ªåŠ¨è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_deps: ${{ steps.build_deps.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t oraclelinux9-builder -f Oraclelinux9-Dockerfile .

      - name: Extract dependencies
        id: build_deps
        run: |
          docker create --name temp-container oraclelinux9-builder
          docker cp temp-container:/dep.tar.gz ./deps.tar.gz
          docker rm temp-container
          echo "::set-output name=success::$(test -f deps.tar.gz && echo 'true' || echo 'false')"

      - name: Upload artifact
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-system-deps
          path: "./deps.tar.gz"

      - name: Generate release tag
        if: steps.check_empty.outputs.is_empty == 'false'
        id: generate_tag
        run: |
          RELEASE_TAG="oraclelinux9-24.04-deps-$(date +'%Y%m%d')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: OracleLinux 9 Docker + System Dependencies (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - OracleLinux 9 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
            
            æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: |
            ${{ github.workspace }}/deps.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
