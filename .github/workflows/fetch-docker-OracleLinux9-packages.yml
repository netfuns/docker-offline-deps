name: Build & Release OracleLinux9 Dependencies

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_deps: ${{ steps.build_deps.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t oraclelinux9-builder -f Dockerfile .

      - name: Extract dependencies
        id: build_deps
        run: |
          docker create --name temp-container oraclelinux9-builder
          docker cp temp-container:/deps.tar.gz .
          docker rm temp-container
          echo "::set-output name=success::$(test -f deps.tar.gz && echo 'true' || echo 'false')"

  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.has_deps == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version tag
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1` | sed 's/^v//')
          echo "RELEASE_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Oracle Linux 9 System Dependencies (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - Oracle Linux 9 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
            
            æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: |
            ${{ github.workspace }}/deps.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
