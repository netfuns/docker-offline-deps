name: Fetch Docker & Ubuntu System Packages for Noble

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq gzip

      # ----------------------------
      # Step 1: Fetch Docker Components
      # ----------------------------
      - name: Fetch latest Docker package URLs
        id: docker_urls
        run: |
          set -euo pipefail
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"
          
          # è·å–é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$BASE_URL/" | tr -d '\r')
          echo "DEBUG: Docker Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # ç²¾ç¡®æå–åŒ…æ–‡ä»¶åçš„å‡½æ•°
          get_latest() {
            local pkg="$1"
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "<a href=\"${pkg}[^\"]+\">" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No Docker package found for ${pkg}" >&2
              exit 1
            fi
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºå¹¶å–æœ€æ–°ç‰ˆæœ¬
            echo "$matches" | sort -Vr | head -n1
          }

          # è·å–å„ç»„ä»¶æœ€æ–°åŒ…æ–‡ä»¶å
          CONTAINERD=$(get_latest "containerd.io") || exit 1
          DOCKER_CE=$(get_latest "docker-ce") || exit 1
          CLI=$(get_latest "docker-ce-cli") || exit 1
          BUILDX_PLUGIN=$(get_latest "docker-buildx-plugin") || exit 1
          COMPOSE_PLUGIN=$(get_latest "docker-compose-plugin") || exit 1

          # è¾“å‡ºå®Œæ•´ä¸‹è½½URL
          echo "CONTAINERD_URL=${BASE_URL}/${CONTAINERD}" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=${BASE_URL}/${DOCKER_CE}" >> $GITHUB_OUTPUT
          echo "CLI_URL=${BASE_URL}/${CLI}" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=${BASE_URL}/${BUILDX_PLUGIN}" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=${BASE_URL}/${COMPOSE_PLUGIN}" >> $GITHUB_OUTPUT

      # ----------------------------
      # Step 2: Fetch Ubuntu System Packages
      # ----------------------------
      - name: Fetch Ubuntu system package URLs
        id: system_urls
        run: |
          set -euo pipefail
          SYSTEM_PACKAGES="uuid-runtime iptables libip4tc2 libip6tc2 libnetfilter-conntrack3 libnfnetlink0 libnftnl11 libxtables12"
          BASE_URL="https://archive.ubuntu.com/ubuntu/dists/${UBUNTU_CODENAME}/main/binary-${ARCH}/Packages.gz"

          # ä¸‹è½½å¹¶è§£å‹åŒ…ç´¢å¼•
          curl -fsSL "$BASE_URL" -o Packages.gz
          gunzip -c Packages.gz > Packages

          # æå–æ‰€æœ‰ç³»ç»ŸåŒ…çš„ä¸‹è½½é“¾æ¥
          while IFS= read -r line; do
            if [[ "$line" == *"Package: "* ]]; then
              pkg=$(echo "$line" | awk '{print $2}')
            elif [[ "$line" == *"Filename: "* ]]; then
              file=$(echo "$line" | awk '{print $2}')
              if [[ " $SYSTEM_PACKAGES " =~ " $pkg " ]]; then
                echo "$pkg: $file"
              fi
            fi
          done < Packages | sort -u | while IFS=": " read -r pkg file; do
            echo "SYSTEM_${pkg^^}_URL=https://archive.ubuntu.com/ubuntu/dists/${UBUNTU_CODENAME}/main/binary-${ARCH}/$file" >> $GITHUB_OUTPUT
          done

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f Packages Packages.gz

      # ----------------------------
      # Step 3: Download All Packages
      # ----------------------------
      - name: Download packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/docker" "$TARGET_DIR/system"
          
          # ä¸‹è½½ Docker ç»„ä»¶
          curl -fsSL "${{ steps.docker_urls.outputs.CONTAINERD_URL }}" -o "$TARGET_DIR/docker/containerd.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.DOCKER_CE_URL }}" -o "$TARGET_DIR/docker/docker-ce.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.CLI_URL }}" -o "$TARGET_DIR/docker/docker-ce-cli.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.BUILDX_PLUGIN_URL }}" -o "$TARGET_DIR/docker/docker-buildx-plugin.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.COMPOSE_PLUGIN_URL }}" -o "$TARGET_DIR/docker/docker-compose-plugin.deb"

          # ä¸‹è½½ç³»ç»ŸåŒ…
          while IFS=": " read -r pkg file; do
            curl -fsSL "${!pkg}" -o "$TARGET_DIR/system/$pkg.deb"
          done < <(env | grep SYSTEM_ | cut -d= -f1)

      - name: Verify downloaded files
        run: |
          echo "Docker components:"
          ls -l "$TARGET_DIR/docker"
          echo "System packages:"
          ls -l "$TARGET_DIR/system"

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip ./*
          echo "Final deps.zip structure:"
          unzip -l deps.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-system-deps
          path: "$TARGET_DIR/deps.zip"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ubuntu-24.04-deps-$(date +'%Y%m%d')
          name: Ubuntu 24.04 Docker + System Dependencies
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - Ubuntu 24.04 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
