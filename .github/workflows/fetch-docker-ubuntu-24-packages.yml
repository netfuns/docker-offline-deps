name: Download Docker & Ubuntu System Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # ç»Ÿä¸€è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šä¸º amd64
  VERSION_FILE: version_info.txt # ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends curl jq gzip

      # ----------------------------
      # Step 1: Prepare Directories
      # ----------------------------
      - name: Create target directory
        run: mkdir -p "$TARGET_DIR"

      # ----------------------------
      # Step 2: Download Docker Componentsï¼ˆå¼ºåŒ–ä¿®å¤ï¼šç²¾å‡†åŒ¹é…+è°ƒè¯•è¾“å‡ºï¼‰
      # ----------------------------
      - name: Fetch Docker package URLs and versions
        id: docker_info
        run: |
          set -euo pipefail
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"
          
          # 1. è·å–é¡µé¢å†…å®¹ï¼ˆå¢åŠ è¶…æ—¶å’Œé‡è¯•ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨ï¼‰
          if ! PAGE_CONTENT=$(curl -fsSL --max-time 30 --retry 3 "$BASE_URL/"); then
            echo "ERROR: Failed to fetch Docker repository page" >&2
            exit 1
          fi
          PAGE_CONTENT=$(echo "$PAGE_CONTENT" | tr -d '\r') # æ¸…ç†æ¢è¡Œç¬¦
          
          # 2. å¼ºåŒ–ç‰ˆ get_latest å‡½æ•°ï¼šç²¾å‡†åŒ¹é…+è°ƒè¯•è¾“å‡º
          get_latest() {
            local pkg="$1"
            # æ ¸å¿ƒä¿®å¤1ï¼šå½»åº•è½¬ä¹‰åŒ…åä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆ. + * ç­‰ï¼‰ï¼Œé¿å…æ­£åˆ™æ­§ä¹‰
            local escaped_pkg=$(echo "$pkg" | sed 's/[.*+?^${}()|[\]\\]/\\&/g')
            echo "DEBUG: Processing package: $pkg (escaped: $escaped_pkg)"
            
            # æ ¸å¿ƒä¿®å¤2ï¼šä¼˜åŒ–æ­£åˆ™ï¼Œç²¾å‡†åŒ¹é…<a href="åŒ…å_ç‰ˆæœ¬_æ¶æ„.deb">æ ¼å¼
            # é¿å…åŒ¹é…åˆ°ç±»ä¼¼ "containerd.io-docs" ç­‰æ— å…³åŒ…
            local regex="<a href=\"(${escaped_pkg}_[0-9]+\.[0-9]+\.[0-9]+[^_\"]*_${ARCH}\.deb)\""
            echo "DEBUG: Using regex: $regex"
            
            # æå–æ‰€æœ‰åŒ¹é…çš„åŒ…æ–‡ä»¶å
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "$regex" | cut -d'"' -f2)
            
            # è°ƒè¯•ï¼šè¾“å‡ºåŒ¹é…ç»“æœ
            if [ -z "$matches" ]; then
              echo "ERROR: No matches found for $pkg. Page snippet (first 500 chars):" >&2
              echo "$PAGE_CONTENT" | head -c 500 >&2 # æ‰“å°éƒ¨åˆ†é¡µé¢å†…å®¹è¾…åŠ©æ’æŸ¥
              exit 1
            fi
            echo "DEBUG: Found matches for $pkg: $matches"
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆé™åºï¼‰ï¼Œå–æœ€æ–°ç‰ˆ
            local latest=$(echo "$matches" | sort -Vr | head -n1)
            echo "DEBUG: Latest version for $pkg: $latest"
            
            # æå–ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼šåŒ…å_ç‰ˆæœ¬_æ¶æ„.deb â†’ ç‰ˆæœ¬ï¼‰
            local version=$(echo "$latest" | sed -E "s/^${escaped_pkg}_([0-9]+\.[0-9]+\.[0-9]+[^_]+)_.*$/\1/")
            if [ -z "$version" ]; then
              echo "ERROR: Failed to extract version from $latest" >&2
              exit 1
            fi
            echo "DEBUG: Extracted version for $pkg: $version"
            
            # è¾“å‡ºåˆ° GITHUB_OUTPUTï¼ˆç¡®ä¿å˜é‡åæ­£ç¡®ï¼‰
            printf "%s=%s\n" "${pkg}_URL" "${BASE_URL}/${latest}" >> "$GITHUB_OUTPUT"
            printf "%s=%s\n" "${pkg}_VERSION" "$version" >> "$GITHUB_OUTPUT"
            echo "DEBUG: Successfully generated outputs for $pkg"
          }

          # è°ƒç”¨å‡½æ•°ï¼ˆä¼˜å…ˆå¤„ç† containerd.ioï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
          get_latest "containerd.io"
          get_latest "docker-ce"
          get_latest "docker-ce-cli"
          get_latest "docker-buildx-plugin"
          get_latest "docker-compose-plugin"

      - name: Download Docker components
        run: |
          set -euo pipefail
          
          # åˆå§‹åŒ–ç‰ˆæœ¬æ–‡ä»¶
          echo "# ç‰ˆæœ¬ä¿¡æ¯" > "$VERSION_FILE"
          echo "## Docker ç»„ä»¶" >> "$VERSION_FILE"
          echo "" >> "$VERSION_FILE"

          # ä¸‹è½½æ¯ä¸ªç»„ä»¶ï¼ˆå¢åŠ å˜é‡å­˜åœ¨æ€§æ ¡éªŒï¼‰
          components=("containerd.io" "docker-ce" "docker-ce-cli" "docker-buildx-plugin" "docker-compose-plugin")
          for comp in "${components[@]}"; do
            url_var="${comp}_URL"
            ver_var="${comp}_VERSION"
            url="${{ steps.docker_info.outputs[$url_var] }}"
            ver="${{ steps.docker_info.outputs[$ver_var] }}"
            
            # æ ¡éªŒå˜é‡æ˜¯å¦ä¸ºç©ºï¼ˆæå‰æŠ¥é”™ï¼Œé¿å…åç»­curlå¤±è´¥ï¼‰
            if [ -z "$url" ] || [ -z "$ver" ]; then
              echo "ERROR: Missing URL/version for $comp (URL: $url, Version: $ver)" >&2
              exit 1
            fi
            
            echo "Downloading $comp ($ver)..."
            if ! curl -fsSL --max-time 60 --retry 3 "$url" -o "$TARGET_DIR/$comp.deb"; then
              echo "ERROR: Failed to download $comp" >&2
              exit 1
            fi
            echo "$comp: $ver" >> "$VERSION_FILE"
            echo "Successfully downloaded $comp"
          done

      # ----------------------------
      # Step 3: Download Ubuntu System Packages
      # ----------------------------
      - name: Define system packages
        run: |
          echo "SYSTEM_PACKAGES=uuid-runtime iptables libip4tc2 libip6tc2 libnetfilter-conntrack3 libnfnetlink0 libnftnl11 libxtables12" >> $GITHUB_ENV

      - name: Download system packages
        run: |
          set -euo pipefail
          packages=(${SYSTEM_PACKAGES// / })
          
          # æ·»åŠ ç³»ç»ŸåŒ…æ ‡é¢˜åˆ°ç‰ˆæœ¬æ–‡ä»¶
          echo "" >> "$VERSION_FILE"
          echo "## Ubuntu ç³»ç»ŸåŒ…" >> "$VERSION_FILE"
          echo "" >> "$VERSION_FILE"
          
          # éå†æ‰€æœ‰å¯èƒ½çš„ä»“åº“å­ç›®å½•
          REPOS=("main" "updates" "security")
          for repo in "${REPOS[@]}"; do
            echo "Trying repository: $repo"
            PACKAGES_GZ_URL="https://archive.ubuntu.com/ubuntu/dists/${UBUNTU_CODENAME}/${repo}/binary-${ARCH}/Packages.gz"
            
            # ä¸‹è½½å¹¶è§£å‹ Packages.gzï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
            if ! curl -fsSL --max-time 30 --retry 3 "$PACKAGES_GZ_URL" -o Packages.gz; then
              echo "WARNING: Failed to download Packages.gz from $repo"
              continue
            fi
            if ! gunzip -c Packages.gz > Packages; then
              echo "WARNING: Failed to extract Packages from $repo"
              rm -f Packages.gz
              continue
            fi
            
            # è§£æ Packages æ–‡ä»¶ï¼ˆæŒ‰åŒ…ä¿¡æ¯å—å¤„ç†ï¼‰
            current_pkg=""
            current_version=""
            current_filename=""
            while IFS= read -r line; do
              if [[ "$line" == "Package: "* ]]; then
                current_pkg=$(echo "$line" | awk '{print $2}')
              elif [[ "$line" == "Version: "* ]]; then
                current_version=$(echo "$line" | awk '{print $2}')
              elif [[ "$line" == "Filename: "* ]]; then
                current_filename=$(echo "$line" | awk '{print $2}')
              elif [[ -z "$line" && -n "$current_pkg" && " ${packages[*]} " =~ " ${current_pkg} " ]]; then
                # é‡åˆ°ç©ºè¡Œ â†’ ä¸€ä¸ªåŒ…ä¿¡æ¯å—ç»“æŸï¼Œå¼€å§‹ä¸‹è½½
                FILE_URL="https://archive.ubuntu.com/ubuntu/${current_filename}"
                echo "Downloading $current_pkg ($current_version) from $repo..."
                if curl -fsSL --max-time 60 --retry 3 "$FILE_URL" -o "$TARGET_DIR/$current_pkg.deb"; then
                  echo "$current_pkg: $current_version" >> "$VERSION_FILE"
                  packages=(${packages[@]/$current_pkg}) # ç§»é™¤å·²ä¸‹è½½çš„åŒ…
                  echo "Successfully downloaded $current_pkg"
                else
                  echo "WARNING: Failed to download $current_pkg from $repo"
                fi
                # é‡ç½®å˜é‡ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªåŒ…
                current_pkg=""
                current_version=""
                current_filename=""
              fi
            done < Packages
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f Packages Packages.gz
            
            # æ‰€æœ‰åŒ…éƒ½ä¸‹è½½å®Œæˆï¼Œæå‰é€€å‡ºå¾ªç¯
            if [ ${#packages[@]} -eq 0 ]; then
              echo "All system packages downloaded successfully!"
              break
            fi
          done

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ‰¾åˆ°çš„åŒ…ï¼ˆæŠ¥é”™é€€å‡ºï¼‰
          if [ ${#packages[@]} -ne 0 ]; then
            echo "ERROR: Missing packages: ${packages[@]}" >&2
            exit 1
          fi

      # ----------------------------
      # Step 4: Verify and Compress
      # ----------------------------
      - name: List files in target directoryï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: |
          echo "Contents of $TARGET_DIR:"
          ls -la "$TARGET_DIR"
          echo "Total files: $(ls -1 "$TARGET_DIR" | wc -l)"

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          tar -czvf deps.tar.gz ./*
          echo "Final deps.tar.gz size: $(du -sh deps.tar.gz | awk '{print $1}')"
          echo "Contents of deps.tar.gz:"
          tar -tf deps.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-system-deps
          path: "$TARGET_DIR/deps.tar.gz"
          retention-days: 7 # å¯é€‰ï¼šè®¾ç½® artifact ä¿ç•™æ—¶é—´

      # ----------------------------
      # Step 5: Create GitHub Release
      # ----------------------------
      - name: Generate release tag
        id: generate_tag
        run: |
          RELEASE_TAG="ubuntu-24.04-deps-$(date +'%Y%m%d')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "Generated release tag: $RELEASE_TAG"

      - name: Read version info
        id: read_version_info
        run: |
          if [ ! -f "$VERSION_FILE" ]; then
            echo "ERROR: Version file $VERSION_FILE not found" >&2
            exit 1
          fi
          VERSION_INFO=$(cat "$VERSION_FILE")
          # è½¬ä¹‰ä¸º JSON æ ¼å¼ï¼Œé¿å… Release body æ ¼å¼é”™ä¹±
          VERSION_INFO_ESCAPED=$(echo "$VERSION_INFO" | jq -s -R .)
          echo "VERSION_INFO=$VERSION_INFO_ESCAPED" >> $GITHUB_ENV
          echo "Successfully read version info"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Ubuntu 24.04 Docker + System Dependencies (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ è‡ªåŠ¨æ„å»ºçš„ä¾èµ–åŒ…ï¼ˆUbuntu 24.04 amd64ï¼‰
            
            ## åŒ…å«ç»„ä»¶ç‰ˆæœ¬
            
            ${{ fromJSON(env.VERSION_INFO) }}
            
            ---
            
            **æ„å»ºä¿¡æ¯**  
            - æ¶æ„: amd64  
            - å·¥ä½œæµ: ${{ github.workflow }}  
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}  
            -  artifact: [ubuntu-24.04-docker-system-deps](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            > æ³¨ï¼šæ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å« Docker å…¨å®¶æ¡¶å’Œç³»ç»Ÿä¾èµ–åŒ…ï¼Œå¯ç›´æ¥ç”¨äºç¦»çº¿å®‰è£…ã€‚
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.tar.gz
          draft: false # æ˜¯å¦ä¸ºè‰ç¨¿ Releaseï¼ˆfalse è¡¨ç¤ºç›´æ¥å‘å¸ƒï¼‰
          prerelease: false # æ˜¯å¦ä¸ºé¢„å‘å¸ƒï¼ˆfalse è¡¨ç¤ºæ­£å¼å‘å¸ƒï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        # ä»…åœ¨ä¸»åˆ†æ”¯è¿è¡Œ Releaseï¼ˆå¯é€‰ï¼Œé¿å…åˆ†æ”¯æ„å»ºè§¦å‘ï¼‰
        if: github.ref == 'refs/heads/main'

      # ----------------------------
      # Step 6: Cleanup
      # ----------------------------
      - name: Cleanup
        if: always() # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦æˆåŠŸï¼Œéƒ½æ‰§è¡Œæ¸…ç†
        run: |
          rm -rf "$TARGET_DIR" "$VERSION_FILE"
          echo "Cleanup completed"
