name: Fetch Docker & Ubuntu System Packages for Noble

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # ç»Ÿä¸€è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq apt-utils

      # ----------------------------
      # Step 1: Fetch Docker Components
      # ----------------------------
      - name: Add Docker GPG key
        run: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

      - name: Add Docker repository
        run: |
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

      - name: Install Docker components
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends docker-ce docker-ce-cli containerd.io

      - name: Download Docker binaries
        run: |
          mkdir -p "$TARGET_DIR/docker"
          docker_version=$(docker --version | awk '{print $3}' | cut -d',' -f1)
          for component in docker-ce-cli containerd.io docker-ce; do
            dpkg -L $component | grep "/$component$" | xargs -I{} cp {} "$TARGET_DIR/docker/"
          done

      # ----------------------------
      # Step 2: Fetch Ubuntu System Packages
      # ----------------------------
      - name: Define system packages
        run: |
          echo "SYSTEM_PACKAGES=uuid-runtime iptables libip4tc2 libip6tc2 libnetfilter-conntrack3 libnfnetlink0 libnftnl11 libxtables12" >> $GITHUB_ENV

      - name: Download system packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/system"
          packages=(${SYSTEM_PACKAGES// / })
          
          # åˆ›å»ºä¸´æ—¶APTç¼“å­˜ç›®å½•
          tmp_cache=$(mktemp -d)
          echo "APT::Cache-Limit 100000000;" | sudo tee /etc/apt/apt.conf.d/99cache-limit >/dev/null
          
          # é…ç½®APTæº
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
          deb-src http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
          EOF

          # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…åˆ°ä¸´æ—¶ç›®å½•
          sudo apt-get update
          sudo apt-get download -d ${packages[@]} --reinstall --allow-downgrades --allow-change-held-packages --target-release=${UBUNTU_CODENAME}

          # ç§»åŠ¨ä¸‹è½½çš„debæ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
          find /var/cache/apt/archives/ -name '*.deb' -exec mv {} "$TARGET_DIR/system/" \;

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$tmp_cache"
          sudo rm -rf /var/cache/apt/archives/*.deb

      # ----------------------------
      # Step 3: Compression & Verification
      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip ./*
          echo "Final deps.zip structure:"
          unzip -l deps.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-system-deps
          path: "$TARGET_DIR/deps.zip"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ubuntu-24.04-deps-$(date +'%Y%m%d')
          name: Ubuntu 24.04 Docker + System Dependencies
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - Ubuntu 24.04 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      # ----------------------------
      # Step 4: Cleanup
      - name: Cleanup
        run: |
          rm -rf "$TARGET_DIR/docker"
          rm -rf "$TARGET_DIR/system"
