name: Download Docker & Ubuntu System Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # ç»Ÿä¸€è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends curl jq gzip

      # ----------------------------
      # Step 1: Download Docker Components
      # ----------------------------
            - name: Fetch Docker package URLs
        id: docker_urls
        run: |
          set -euo pipefail
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"
          
          # è·å–é¡µé¢å†…å®¹ï¼Œå¢åŠ  -L å‚æ•°å¤„ç†é‡å®šå‘
          echo "DEBUG: Fetching page content from $BASE_URL/"
          PAGE_CONTENT=$(curl -fsSL -L "$BASE_URL/" | tr -d '\r')
          
          # è¾“å‡ºé¡µé¢å†…å®¹çš„å‰ 100 è¡Œï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "DEBUG: First 100 lines of page content:"
          echo "$PAGE_CONTENT" | head -n 100
          
          # ç²¾ç¡®æå–åŒ…æ–‡ä»¶åçš„å‡½æ•°
          get_latest() {
            local pkg="$1"
            echo "DEBUG: Trying to find latest package for $pkg"
            
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›´æ¥åŒ¹é…åŒ…åå¼€å¤´ã€ç‰ˆæœ¬å·å’Œ .deb ç»“å°¾
            # å¯¹äº containerd.ioï¼ŒåŒ¹é…æ ¼å¼ä¸º containerd.io_<version>_amd64.deb
            local regex="<a href=\"(${pkg}_[^\"_]+\.deb)\">"
            echo "DEBUG: Using regex: $regex"
            
            # æå–æ‰€æœ‰åŒ¹é…çš„é“¾æ¥
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "$regex" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No package found for $pkg" >&2
              echo "ERROR: Please check if the package name and regex are correct." >&2
              exit 1
            fi
            
            # è¾“å‡ºæ‰€æœ‰åŒ¹é…åˆ°çš„ç»“æœ
            echo "DEBUG: Found matches for $pkg:"
            echo "$matches"
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºå¹¶å–æœ€æ–°ç‰ˆæœ¬
            local latest=$(echo "$matches" | sort -Vr | head -n1)
            echo "DEBUG: Latest version for $pkg is $latest"
            echo "$latest"
          }

          # è·å–å„ç»„ä»¶æœ€æ–°åŒ…æ–‡ä»¶å
          CONTAINERD=$(get_latest "containerd.io") || exit 1
          DOCKER_CE=$(get_latest "docker-ce") || exit 1
          CLI=$(get_latest "docker-ce-cli") || exit 1
          BUILDX_PLUGIN=$(get_latest "docker-buildx-plugin") || exit 1
          COMPOSE_PLUGIN=$(get_latest "docker-compose-plugin") || exit 1

          # è¾“å‡ºå®Œæ•´ä¸‹è½½URL
          echo "CONTAINERD_URL=${BASE_URL}/${CONTAINERD}" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=${BASE_URL}/${DOCKER_CE}" >> $GITHUB_OUTPUT
          echo "CLI_URL=${BASE_URL}/${CLI}" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=${BASE_URL}/${BUILDX_PLUGIN}" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=${BASE_URL}/${COMPOSE_PLUGIN}" >> $GITHUB_OUTPUT

      - name: Download Docker packages
        run: |
          set -euo pipefail
          # åˆ›å»º docker å­ç›®å½•
          mkdir -p "$TARGET_DIR/docker"
          
          # ä»ä¸Šä¸ªæ­¥éª¤çš„è¾“å‡ºä¸­è·å– URL å¹¶ä¸‹è½½
          echo "Downloading Docker packages..."
          curl -fsSL "${{ steps.docker_urls.outputs.CONTAINERD_URL }}" -o "$TARGET_DIR/docker/containerd.io.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.DOCKER_CE_URL }}" -o "$TARGET_DIR/docker/docker-ce.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.CLI_URL }}" -o "$TARGET_DIR/docker/docker-ce-cli.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.BUILDX_PLUGIN_URL }}" -o "$TARGET_DIR/docker/docker-buildx-plugin.deb"
          curl -fsSL "${{ steps.docker_urls.outputs.COMPOSE_PLUGIN_URL }}" -o "$TARGET_DIR/docker/docker-compose-plugin.deb"
          
          # è°ƒè¯•ï¼šåˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          echo "Docker packages downloaded:"
          ls -la "$TARGET_DIR/docker/"

      # ----------------------------
      # Step 2: Download Ubuntu System Packages
      # ----------------------------
      - name: Define system packages
        run: |
          echo "SYSTEM_PACKAGES=uuid-runtime iptables libip4tc2 libip6tc2 libnetfilter-conntrack3 libnfnetlink0 libnftnl11 libxtables12" >> $GITHUB_ENV

      - name: Download system packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/system"
          packages=(${SYSTEM_PACKAGES// / })
          
          # éå†æ‰€æœ‰å¯èƒ½çš„ä»“åº“å­ç›®å½•
          REPOS=("main" "updates" "security")
          for repo in "${REPOS[@]}"; do
            echo "Trying repository: $repo"
            PACKAGES_GZ_URL="https://archive.ubuntu.com/ubuntu/dists/${UBUNTU_CODENAME}/${repo}/binary-${ARCH}/Packages.gz"
            if ! curl -fsSL "$PACKAGES_GZ_URL" -o Packages.gz; then
              echo "WARNING: Failed to download Packages.gz from $repo"
              continue
            fi
            
            if ! gunzip -c Packages.gz > Packages; then
              echo "WARNING: Failed to extract Packages from $repo"
              rm -f Packages.gz
              continue
            fi
            
            # è§£æPackagesæ–‡ä»¶å¹¶ä¸‹è½½å¯¹åº”åŒ…
            while IFS= read -r line; do
              if [[ "$line" == "Package: "* ]]; then
                current_pkg=$(echo "$line" | awk '{print $2}')
              elif [[ "$line" == "Filename: "* && -n "$current_pkg" ]]; then
                # æ£€æŸ¥å½“å‰åŒ…æ˜¯å¦åœ¨éœ€è¦ä¸‹è½½çš„åˆ—è¡¨ä¸­
                if [[ " ${packages[*]} " =~ " ${current_pkg} " ]]; then
                  file=$(echo "$line" | awk '{print $2}')
                  FILE_URL="https://archive.ubuntu.com/ubuntu/${file}"
                  echo "Downloading $current_pkg from $repo..."
                  if curl -fsSL "$FILE_URL" -o "$TARGET_DIR/system/$current_pkg.deb"; then
                    # ç§»é™¤å·²æˆåŠŸä¸‹è½½çš„åŒ…
                    packages=(${packages[@]/$current_pkg})
                    echo "Successfully downloaded $current_pkg"
                  else
                    echo "WARNING: Failed to download $current_pkg from $repo"
                  fi
                fi
              fi
            done < Packages
            
            rm -f Packages Packages.gz
            
            if [ ${#packages[@]} -eq 0 ]; then
              echo "All system packages downloaded successfully!"
              break
            fi
          done

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ‰¾åˆ°çš„åŒ…
          if [ ${#packages[@]} -ne 0 ]; then
            echo "ERROR: Missing system packages: ${packages[@]}" >&2
            exit 1
          fi

          # è°ƒè¯•ï¼šåˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          echo "System packages downloaded:"
          ls -la "$TARGET_DIR/system/"

      # ----------------------------
      # Step 3: Merge & Compress
      # ----------------------------
      - name: Merge all packages into root deps directory
        run: |
          # å°† docker å’Œ system ç›®å½•ä¸‹çš„æ‰€æœ‰ .deb æ–‡ä»¶ç§»åŠ¨åˆ° deps æ ¹ç›®å½•
          mv "$TARGET_DIR/docker"/*.deb "$TARGET_DIR/"
          mv "$TARGET_DIR/system"/*.deb "$TARGET_DIR/"
          # åˆ é™¤ç©ºçš„å­ç›®å½•
          rmdir "$TARGET_DIR/docker" "$TARGET_DIR/system"
          
          # è°ƒè¯•ï¼šåˆ—å‡ºå°†è¦è¢«å‹ç¼©çš„æ‰€æœ‰æ–‡ä»¶
          echo "Final package list to compress:"
          ls -la "$TARGET_DIR/"

      - name: Check if deps directory is empty
        id: check_empty
        run: |
          if [ -z "$(ls -A $TARGET_DIR)" ]; then
            echo "ERROR: No files found in $TARGET_DIR. Aborting compression." >&2
            echo "is_empty=true" >> $GITHUB_OUTPUT
          else
            echo "is_empty=false" >> $GITHUB_OUTPUT
          fi

      - name: Compress deps directory
        if: steps.check_empty.outputs.is_empty == 'false'
        run: |
          cd "$TARGET_DIR"
          tar -czvf deps.tar.gz ./*.deb
          echo "Final deps.tar.gz structure:"
          tar -tf deps.tar.gz

      - name: Upload artifact
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-system-deps
          path: "$TARGET_DIR/deps.tar.gz"

      # ----------------------------
      # Step 4-6: Create Release (only if files exist)
      # ----------------------------
      - name: Generate release tag
        if: steps.check_empty.outputs.is_empty == 'false'
        id: generate_tag
        run: |
          RELEASE_TAG="ubuntu-24.04-deps-$(date +'%Y%m%d')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Ubuntu 24.04 Docker + System Dependencies (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - Ubuntu 24.04 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
            
            æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      # ----------------------------
      # Step 7: Cleanup
      # ----------------------------
      - name: Cleanup
        run: |
          rm -rf "$TARGET_DIR"
