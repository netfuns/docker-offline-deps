name: Fetch Latest Docker Packages for Ubuntu 24.04

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch Docker package URLs
        id: docker_urls
        run: |
          set -euo pipefail
          DOCKER_BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"
          
          # è·å–é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$DOCKER_BASE_URL/" | tr -d '\r')
          echo "DEBUG: Docker Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # ç²¾ç¡®æå– Docker åŒ…æ–‡ä»¶åçš„å‡½æ•°
          get_docker_latest() {
            local pkg="$1"
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "<a href=\"${pkg}[^\"]+\">" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No Docker package found for ${pkg}" >&2
              return 1
            fi
            
            echo "$matches" | sort -Vr | head -n1
          }

          # è·å– Docker ç»„ä»¶
          CONTAINERD=$(get_docker_latest "containerd.io") || exit 1
          DOCKER_CE=$(get_docker_latest "docker-ce") || exit 1
          CLI=$(get_docker_latest "docker-ce-cli") || exit 1
          BUILDX_PLUGIN=$(get_docker_latest "docker-buildx-plugin") || exit 1
          COMPOSE_PLUGIN=$(get_docker_latest "docker-compose-plugin") || exit 1

          # è¾“å‡º Docker åŒ… URL
          echo "DOCKER_COMPONENTS_URLS=($CONTAINERD $DOCKER_CE $CLI $BUILDX_PLUGIN $COMPOSE_PLUGIN)" >> $GITHUB_OUTPUT

      - name: Fetch system tool URLs
        id: system_urls
        run: |
          set -euo pipefail
          SYSTEM_BASE_URL="https://archive.ubuntu.com/ubuntu/dists/${UBUNTU_CODENAME}/main/binary-${ARCH}/"
          
          # è·å–é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$SYSTEM_BASE_URL/" | tr -d '\r')
          echo "DEBUG: System Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # ç²¾ç¡®æå–ç³»ç»Ÿå·¥å…·åŒ…æ–‡ä»¶åçš„å‡½æ•°
          get_system_latest() {
            local pkg="$1"
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "<a href=\"${pkg}[^\"]+_${ARCH}\.deb\"" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No system package found for ${pkg}" >&2
              return 1
            fi
            
            echo "$matches" | sort -Vr | head -n1
          }

          # è·å–ç³»ç»Ÿå·¥å…·åŒ…
          UUID_RUNTIME=$(get_system_latest "uuid-runtime") || exit 1
          IPTABLES=$(get_system_latest "iptables") || exit 1
          LIBIP4TC=$(get_system_latest "libip4tc2") || exit 1
          LIBIP6TC=$(get_system_latest "libip6tc2") || exit 1
          LIBNETFILTER_CONNTRACK=$(get_system_latest "libnetfilter-conntrack3") || exit 1
          LIBNFNETLINK=$(get_system_latest "libnfnetlink0") || exit 1
          LIBNFTNL=$(get_system_latest "libnftnl11") || exit 1
          LIBXTABLES=$(get_system_latest "libxtables12") || exit 1

          # è¾“å‡ºç³»ç»Ÿå·¥å…·åŒ… URL
          echo "SYSTEM_TOOLS_URLS=($UUID_RUNTIME $IPTABLES $LIBIP4TC $LIBIP6TC $LIBNETFILTER_CONNTRACK $LIBNFNETLINK $LIBNFTNL $LIBXTABLES)" >> $GITHUB_OUTPUT

      - name: Download packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/deps"
          
          # ä¸‹è½½ Docker ç»„ä»¶
          IFS=' ' read -ra DOCKER_URLS <<< "${DOCKER_COMPONENTS_URLS[@]}"
          for url in "${DOCKER_URLS[@]}"; do
            pkg_name=$(basename "$url")
            curl -fsSL "$url" -o "$TARGET_DIR/deps/$pkg_name"
          done

          # ä¸‹è½½ç³»ç»Ÿå·¥å…·åŒ…
          IFS=' ' read -ra SYSTEM_URLS <<< "${SYSTEM_TOOLS_URLS[@]}"
          for url in "${SYSTEM_URLS[@]}"; do
            pkg_name=$(basename "$url")
            curl -fsSL "$url" -o "$TARGET_DIR/deps/$pkg_name"
          done

      - name: Verify downloaded files
        run: |
          ls -lR "$TARGET_DIR/deps"
          echo "Docker components:"
          dpkg-deb -f "$TARGET_DIR/deps/containerd.io.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce-cli.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-buildx-plugin.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-compose-plugin.deb" Package Version

          echo "System tools:"
          dpkg-deb -f "$TARGET_DIR/deps/uuid-runtime.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/iptables.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libip4tc2.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libip6tc2.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnetfilter-conntrack3.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnfnetlink0.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnftnl11.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libxtables12.deb" Package Version

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip deps/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-deps
          path: "$TARGET_DIR/deps.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ubuntu-24.04-docker-packages-$(date +%Y%m%d)
          name: Ubuntu 24.04 Docker Packages $(date +%Y%m%d)
          body: |
            ğŸ“¦ Ubuntu 24.04 (Noble) Docker ç»„ä»¶åŒ…ï¼š
            
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            
            ğŸ”§ ç³»ç»Ÿä¾èµ–å·¥å…·ï¼š
            - uuid-runtime
            - iptables
            - libip4tc2
            - libip6tc2
            - libnetfilter-conntrack3
            - libnfnetlink0
            - libnftnl11
            - libxtables12
            
            åŒ…å«æ¶æ„: amd64
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
