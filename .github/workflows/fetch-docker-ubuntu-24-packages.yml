name: Fetch Latest Docker Packages for Ubuntu 24.04

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # ÊØèÂ§© 02:00 UTC Ëá™Âä®ËøêË°å

env:
  UBUNTU_CODENAME: noble   # Âõ∫ÂÆö‰∏∫ Ubuntu 24.04
  TARGET_DIR: deps         # Ëß£ÂéãÁõÆÊ†áÁõÆÂΩï

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch latest package URLs
        id: package_urls
        run: |
          set -euo pipefail
          ARCH=$(dpkg --print-architecture)
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/$ARCH"

          # Ëé∑ÂèñÊúÄÊñ∞ÁâàÊú¨ÂåÖÁöÑÈÄöÁî®ÂáΩÊï∞
          get_latest() {
            local pkg="$1"
            curl -fsSL "$BASE_URL/" \
              | grep -oP 'href="\K[^"]+'"$pkg"'(?=_'"$ARCH"'\.deb)' \
              | sort -Vr | head -n1
          }

          # Ëé∑ÂèñÂêÑÁªÑ‰ª∂ÊúÄÊñ∞ÂåÖÈìæÊé•
          CONTAINERD=$(get_latest containerd.io)
          DOCKER_CE=$(get_latest docker-ce)
          CLI=$(get_latest docker-ce-cli)
          BUILDX_PLUGIN=$(get_latest docker-buildx-plugin)
          COMPOSE_PLUGIN=$(get_latest docker-compose-plugin)

          # ËæìÂá∫Âà∞ GitHub Actions ÁéØÂ¢ÉÂèòÈáè
          echo "CONTAINERD_URL=$CONTAINERD" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=$DOCKER_CE" >> $GITHUB_OUTPUT
          echo "CLI_URL=$CLI" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=$BUILDX_PLUGIN" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=$COMPOSE_PLUGIN" >> $GITHUB_OUTPUT

      - name: Download packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR"
          cd "$TARGET_DIR"

          # ‰∏ãËΩΩÊâÄÊúâÁªÑ‰ª∂
          curl -fsSL "${{ steps.package_urls.outputs.CONTAINERD_URL }}" -o containerd.deb
          curl -fsSL "${{ steps.package_urls.outputs.DOCKER_CE_URL }}" -o docker-ce.deb
          curl -fsSL "${{ steps.package_urls.outputs.CLI_URL }}" -o docker-ce-cli.deb
          curl -fsSL "${{ steps.package_urls.outputs.BUILDX_PLUGIN_URL }}" -o docker-buildx-plugin.deb
          curl -fsSL "${{ steps.package_urls.outputs.COMPOSE_PLUGIN_URL }}" -o docker-compose-plugin.deb

      - name: Verify downloaded files
        run: |
          ls -lR "$TARGET_DIR"
          echo "Found packages:"
          echo "-----------------"
          echo "- containerd.deb"
          echo "- docker-ce.deb"
          echo "- docker-ce-cli.deb"
          echo "- docker-buildx-plugin.deb"
          echo "- docker-compose-plugin.deb"

      - name: Create deps directory structure
        run: |
          mkdir -p "$TARGET_DIR/deps"
          mv *.deb "$TARGET_DIR/deps/"

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip deps/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-deps
          path: "$TARGET_DIR/deps.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ubuntu-24.04-docker-packages-$(date +%Y%m%d)
          name: Ubuntu 24.04 Docker Packages $(date +%Y%m%d)
          body: |
            üì¶ Ubuntu 24.04 (Noble) Docker ÁªÑ‰ª∂ÂåÖÔºö
            
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            
            ÂåÖÂê´Êû∂ÊûÑÔºö$(dpkg --print-architecture)
          files: |
            ${{ github.workspace }}/ubuntu-24.04-docker-deps/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
