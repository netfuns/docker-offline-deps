name: Fetch Latest Docker Packages for Ubuntu 24.04

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch latest package URLs
        id: package_urls
        run: |
          set -euo pipefail
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"
          
          # è·å–é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$BASE_URL/" | tr -d '\r')
          echo "DEBUG: Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # ç²¾ç¡®æå–åŒ…æ–‡ä»¶åçš„å‡½æ•°
          get_latest() {
            local pkg="$1"
            # æå–æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶å
            local matches=$(echo "$PAGE_CONTENT" | grep -oE "<a href=\"${pkg}[^\"]+\">" | cut -d'"' -f2)
            
            if [ -z "$matches" ]; then
              echo "ERROR: No package found for ${pkg}" >&2
              return 1
            fi
            
            # æŒ‰ç‰ˆæœ¬å·æ’åºå¹¶å–æœ€æ–°ç‰ˆæœ¬
            echo "$matches" | sort -Vr | head -n1
          }

          # è·å– Docker ç»„ä»¶
          CONTAINERD=$(get_latest "containerd.io") || exit 1
          DOCKER_CE=$(get_latest "docker-ce") || exit 1
          CLI=$(get_latest "docker-ce-cli") || exit 1
          BUILDX_PLUGIN=$(get_latest "docker-buildx-plugin") || exit 1
          COMPOSE_PLUGIN=$(get_latest "docker-compose-plugin") || exit 1

          # è·å–ç³»ç»Ÿå·¥å…·åŒ…
          UUID_RUNTIME=$(get_latest "uuid-runtime") || exit 1
          IPTABLES=$(get_latest "iptables") || exit 1
          LIBIP4TC=$(get_latest "libip4tc2") || exit 1
          LIBIP6TC=$(get_latest "libip6tc2") || exit 1
          LIBNETFILTER_CONNTRACK=$(get_latest "libnetfilter-conntrack3") || exit 1
          LIBNFNETLINK=$(get_latest "libnfnetlink0") || exit 1
          LIBNFTNL=$(get_latest "libnftnl11") || exit 1
          LIBXTABLES=$(get_latest "libxtables12") || exit 1

          # è¾“å‡ºå®Œæ•´ä¸‹è½½URL
          echo "CONTAINERD_URL=${BASE_URL}/${CONTAINERD}" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=${BASE_URL}/${DOCKER_CE}" >> $GITHUB_OUTPUT
          echo "CLI_URL=${BASE_URL}/${CLI}" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=${BASE_URL}/${BUILDX_PLUGIN}" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=${BASE_URL}/${COMPOSE_PLUGIN}" >> $GITHUB_OUTPUT

          # è¾“å‡ºç³»ç»Ÿå·¥å…·åŒ…URL
          echo "UUID_RUNTIME_URL=${BASE_URL}/${UUID_RUNTIME}" >> $GITHUB_OUTPUT
          echo "IPTABLES_URL=${BASE_URL}/${IPTABLES}" >> $GITHUB_OUTPUT
          echo "LIBIP4TC_URL=${BASE_URL}/${LIBIP4TC}" >> $GITHUB_OUTPUT
          echo "LIBIP6TC_URL=${BASE_URL}/${LIBIP6TC}" >> $GITHUB_OUTPUT
          echo "LIBNETFILTER_CONNTRACK_URL=${BASE_URL}/${LIBNETFILTER_CONNTRACK}" >> $GITHUB_OUTPUT
          echo "LIBNFNETLINK_URL=${BASE_URL}/${LIBNFNETLINK}" >> $GITHUB_OUTPUT
          echo "LIBNFTNL_URL=${BASE_URL}/${LIBNFTNL}" >> $GITHUB_OUTPUT
          echo "LIBXTABLES_URL=${BASE_URL}/${LIBXTABLES}" >> $GITHUB_OUTPUT

          # è°ƒè¯•è¾“å‡º
          echo "DEBUG: Found packages:"
          echo "Containerd: $CONTAINERD"
          echo "Docker CE: $DOCKER_CE"
          echo "CLI: $CLI"
          echo "Buildx: $BUILDX_PLUGIN"
          echo "Compose: $COMPOSE_PLUGIN"
          echo "UUID Runtime: $UUID_RUNTIME"
          echo "Iptables: $IPTABLES"
          echo "Libip4tc: $LIBIP4TC"
          echo "Libip6tc: $LIBIP6TC"
          echo "Libnetfilter Conntrack: $LIBNETFILTER_CONNTRACK"
          echo "Libnfnetlink: $LIBNFNETLINK"
          echo "Libnftnl: $LIBNFTNL"
          echo "Libxtables: $LIBXTABLES"

      - name: Download packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/deps"
          
          # ä¸‹è½½ Docker ç»„ä»¶
          curl -fsSL "${{ steps.package_urls.outputs.CONTAINERD_URL }}" -o "$TARGET_DIR/deps/containerd.deb"
          curl -fsSL "${{ steps.package_urls.outputs.DOCKER_CE_URL }}" -o "$TARGET_DIR/deps/docker-ce.deb"
          curl -fsSL "${{ steps.package_urls.outputs.CLI_URL }}" -o "$TARGET_DIR/deps/docker-ce-cli.deb"
          curl -fsSL "${{ steps.package_urls.outputs.BUILDX_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-buildx-plugin.deb"
          curl -fsSL "${{ steps.package_urls.outputs.COMPOSE_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-compose-plugin.deb"

          # ä¸‹è½½ç³»ç»Ÿå·¥å…·åŒ…
          curl -fsSL "${{ steps.package_urls.outputs.UUID_RUNTIME_URL }}" -o "$TARGET_DIR/deps/uuid-runtime.deb"
          curl -fsSL "${{ steps.package_urls.outputs.IPTABLES_URL }}" -o "$TARGET_DIR/deps/iptables.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBIP4TC_URL }}" -o "$TARGET_DIR/deps/libip4tc2.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBIP6TC_URL }}" -o "$TARGET_DIR/deps/libip6tc2.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBNETFILTER_CONNTRACK_URL }}" -o "$TARGET_DIR/deps/libnetfilter-conntrack3.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBNFNETLINK_URL }}" -o "$TARGET_DIR/deps/libnfnetlink0.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBNFTNL_URL }}" -o "$TARGET_DIR/deps/libnftnl11.deb"
          curl -fsSL "${{ steps.package_urls.outputs.LIBXTABLES_URL }}" -o "$TARGET_DIR/deps/libxtables12.deb"

      - name: Verify downloaded files
        run: |
          ls -lR "$TARGET_DIR/deps"
          echo "Docker components:"
          dpkg-deb -f "$TARGET_DIR/deps/containerd.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce-cli.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-buildx-plugin.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-compose-plugin.deb" Package Version

          echo "System tools:"
          dpkg-deb -f "$TARGET_DIR/deps/uuid-runtime.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/iptables.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libip4tc2.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libip6tc2.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnetfilter-conntrack3.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnfnetlink0.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libnftnl11.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/libxtables12.deb" Package Version

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip deps/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-deps
          path: "$TARGET_DIR/deps.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ubuntu-24.04-docker-packages-$(date +%Y%m%d)
          name: Ubuntu 24.04 Docker Packages $(date +%Y%m%d)
          body: |
            ğŸ“¦ Ubuntu 24.04 (Noble) Docker ç»„ä»¶åŒ…ï¼š
            
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            
            ğŸ”§ ç³»ç»Ÿä¾èµ–å·¥å…·ï¼š
            - uuid-runtime
            - iptables
            - libip4tc2
            - libip6tc2
            - libnetfilter-conntrack3
            - libnfnetlink0
            - libnftnl11
            - libxtables12
            
            åŒ…å«æ¶æ„: amd64
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
