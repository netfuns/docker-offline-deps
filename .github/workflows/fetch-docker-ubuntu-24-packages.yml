name: Fetch Latest Docker Packages for Ubuntu 24.04

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

env:
  UBUNTU_CODENAME: noble   # å›ºå®šä¸º Ubuntu 24.04
  TARGET_DIR: deps         # è§£å‹ç›®æ ‡ç›®å½•
  ARCH: amd64              # å›ºå®šæ¶æ„ä¸º amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch latest package URLs
        id: package_urls
        run: |
          set -euo pipefail
          BASE_URL="https://download.docker.com/linux/ubuntu/dists/${UBUNTU_CODENAME}/pool/stable/${ARCH}"

          # è·å–é¡µé¢å†…å®¹
          PAGE_CONTENT=$(curl -fsSL "$BASE_URL/" || echo "ERROR: Failed to fetch page")
          echo "DEBUG: Repository page content:"
          echo "$PAGE_CONTENT" | head -n 20

          # ç²¾ç¡®åŒ¹é…åŒ…é“¾æ¥çš„å‡½æ•°
          get_latest() {
            local pkg="$1"
            # åŒ¹é…æ ¼å¼: <a href="package_name_version_arch.deb">package_name...</a>
            echo "$PAGE_CONTENT" | grep -oP "<a href=\"\K${pkg}(_[^-]+)*-${ARCH}\.deb" | sort -Vr | head -n1
          }

          # è·å–å„ç»„ä»¶æœ€æ–°åŒ…æ–‡ä»¶å
          CONTAINERD=$(get_latest "containerd.io") || { echo "Containerd not found"; exit 1; }
          DOCKER_CE=$(get_latest "docker-ce") || { echo "Docker CE not found"; exit 1; }
          CLI=$(get_latest "docker-ce-cli") || { echo "CLI not found"; exit 1; }
          BUILDX_PLUGIN=$(get_latest "docker-buildx-plugin") || { echo "Buildx Plugin not found"; exit 1; }
          COMPOSE_PLUGIN=$(get_latest "docker-compose-plugin") || { echo "Compose Plugin not found"; exit 1; }

          # è¾“å‡ºå®Œæ•´ä¸‹è½½URL
          echo "CONTAINERD_URL=${BASE_URL}/${CONTAINERD}" >> $GITHUB_OUTPUT
          echo "DOCKER_CE_URL=${BASE_URL}/${DOCKER_CE}" >> $GITHUB_OUTPUT
          echo "CLI_URL=${BASE_URL}/${CLI}" >> $GITHUB_OUTPUT
          echo "BUILDX_PLUGIN_URL=${BASE_URL}/${BUILDX_PLUGIN}" >> $GITHUB_OUTPUT
          echo "COMPOSE_PLUGIN_URL=${BASE_URL}/${COMPOSE_PLUGIN}" >> $GITHUB_OUTPUT

          # è°ƒè¯•è¾“å‡º
          echo "DEBUG: Found packages:"
          echo "Containerd: $CONTAINERD"
          echo "Docker CE: $DOCKER_CE"
          echo "CLI: $CLI"
          echo "Buildx: $BUILDX_PLUGIN"
          echo "Compose: $COMPOSE_PLUGIN"

      - name: Download packages
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR/deps"
          
          # ä¸‹è½½æ‰€æœ‰ç»„ä»¶
          curl -fsSL "${{ steps.package_urls.outputs.CONTAINERD_URL }}" -o "$TARGET_DIR/deps/containerd.deb"
          curl -fsSL "${{ steps.package_urls.outputs.DOCKER_CE_URL }}" -o "$TARGET_DIR/deps/docker-ce.deb"
          curl -fsSL "${{ steps.package_urls.outputs.CLI_URL }}" -o "$TARGET_DIR/deps/docker-ce-cli.deb"
          curl -fsSL "${{ steps.package_urls.outputs.BUILDX_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-buildx-plugin.deb"
          curl -fsSL "${{ steps.package_urls.outputs.COMPOSE_PLUGIN_URL }}" -o "$TARGET_DIR/deps/docker-compose-plugin.deb"

      - name: Verify downloaded files
        run: |
          ls -lR "$TARGET_DIR/deps"
          echo "Package versions:"
          dpkg-deb -f "$TARGET_DIR/deps/containerd.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-ce-cli.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-buildx-plugin.deb" Package Version
          dpkg-deb -f "$TARGET_DIR/deps/docker-compose-plugin.deb" Package Version

      - name: Compress deps directory
        run: |
          cd "$TARGET_DIR"
          zip -r deps.zip deps/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-docker-deps
          path: "$TARGET_DIR/deps.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ubuntu-24.04-docker-packages-$(date +%Y%m%d)
          name: Ubuntu 24.04 Docker Packages $(date +%Y%m%d)
          body: |
            ğŸ“¦ Ubuntu 24.04 (Noble) Docker ç»„ä»¶åŒ…ï¼š
            
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            
            åŒ…å«æ¶æ„: amd64
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
