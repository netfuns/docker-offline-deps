name: Build & Release Rhel9 Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 1 * *' # æ¯æœˆ1å· 01:00 UTC è‡ªåŠ¨è¿è¡Œ
env:
  TARGET_DIR: deps         # ç»Ÿä¸€è§£å‹ç›®æ ‡ç›®å½•

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_deps: ${{ steps.build_deps.outputs.success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t Rhel9-builder -f Rhel9-Dockerfile .

      - name: Extract dependencies
        id: build_deps
        run: |
          mkdir -p $TARGET_DIR
          docker create --name temp-container Rhel9-builder
          docker cp temp-container:/tmp.tar.gz "$TARGET_DIR/deps.tar.gz"
          docker rm temp-container

      - name: Check if deps directory is empty
        id: check_empty
        run: |
          if [ -z "$(ls -A $TARGET_DIR)" ]; then
            echo "ERROR: No files found in $TARGET_DIR. Aborting compression." >&2
            echo "is_empty=true" >> $GITHUB_OUTPUT
          else
            echo "is_empty=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: Rhel9-docker-system-deps
          path: "$TARGET_DIR/deps.tar.gz"

      - name: Generate release tag
        if: steps.check_empty.outputs.is_empty == 'false'
        id: generate_tag
        run: |
          RELEASE_TAG="Rhel9-deps-$(date +'%Y%m%d')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        if: steps.check_empty.outputs.is_empty == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: RHEL 9 Docker + System Dependencies (${{ env.RELEASE_TAG }})
          body: |
            ğŸ“¦ åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š
            
            - Docker CE å…¨å®¶æ¡¶
            - RHEL 9 ç³»ç»Ÿå·¥å…·åŒ…
            
            æ”¯æŒæ¶æ„: amd64
            
            æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: |
            ${{ github.workspace }}/${{ env.TARGET_DIR }}/deps.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      - name: Cleanup
        run: |
          rm -rf "$TARGET_DIR"
