name: Fetch Latest Docker Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰

permissions:
  contents: write # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„äº§

env:
  UBUNTU_CODENAME: noble   # Ubuntu 24.04
  CENTOS_STREAM_VER: 9     # CentOS Stream 9

jobs:
  ubuntu-noble:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch latest .deb URLs for Ubuntu ${{ env.UBUNTU_CODENAME }}
        id: ubuntu_urls
        run: |
          set -euo pipefail
          ARCH=$(dpkg --print-architecture) # è·å–ç³»ç»Ÿæ¶æ„ï¼ˆå¦‚ amd64/arm64ï¼‰
          BASE="https://download.docker.com/linux/ubuntu/dists/${{ env.UBUNTU_CODENAME }}/pool/stable/$ARCH"
          echo "BASE=$BASE" >> "$GITHUB_OUTPUT"

          # è§£ææœ€æ–°ç‰ˆæœ¬åŒ…çš„å‡½æ•°
          latest() {
            curl -fsSL "$BASE/" \
              | grep -oP 'href="\K[^"]+'"$1"'(?=_'"$ARCH"'\.deb)' \
              | sort -Vr | head -n1
          }

          # è·å–å„åŒ…æœ€æ–°ç‰ˆæœ¬é“¾æ¥
          echo "containerd=$(latest containerd.io)" >> "$GITHUB_OUTPUT"
          echo "docker_ce=$(latest docker-ce)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_cli=$(latest docker-ce-cli)" >> "$GITHUB_OUTPUT"
          echo "docker_buildx_plugin=$(latest docker-buildx-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_compose_plugin=$(latest docker-compose-plugin)" >> "$GITHUB_OUTPUT"

      - name: Download Ubuntu packages
        run: |
          set -euo pipefail
          ARCH=$(dpkg --print-architecture) # å†æ¬¡ç¡®ä¿ ARCH å¯ç”¨
          PKG_DIR="ubuntu-${{ env.UBUNTU_CODENAME }}-$ARCH"
          mkdir -p "$PKG_DIR"
          cd "$PKG_DIR"

          # ä¸‹è½½æ‰€æœ‰åŒ…
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.containerd }}" -o "containerd.io_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_ce }}" -o "docker-ce_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_ce_cli }}" -o "docker-ce-cli_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_buildx_plugin }}" -o "docker-buildx-plugin_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_compose_plugin }}" -o "docker-compose-plugin_${ARCH}.deb"

      - name: Upload Ubuntu artifact
        uses: actions/upload-artifact@v4
        with:
          name: $PKG_DIR
          path: $PKG_DIR

  centos-stream-9:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq rpm2cpio cpio

      - name: Fetch latest .rpm URLs for CentOS Stream ${{ env.CENTOS_STREAM_VER }}
        id: centos_urls
        run: |
          set -euo pipefail
          ARCH=$(uname -m) # è·å–ç³»ç»Ÿæ¶æ„ï¼ˆå¦‚ x86_64/aarch64ï¼‰
          BASE="https://download.docker.com/linux/centos/${{ env.CENTOS_STREAM_VER }}/$ARCH/stable/Packages"
          echo "BASE=$BASE" >> "$GITHUB_OUTPUT"

          # è§£ææœ€æ–°ç‰ˆæœ¬åŒ…çš„å‡½æ•°
          latest() {
            curl -fsSL "$BASE/" \
              | grep -oP 'href="\K[^"]+'"$1"'(?=-'"$ARCH"'\.rpm)' \
              | sort -Vr | head -n1
          }

          # è·å–å„åŒ…æœ€æ–°ç‰ˆæœ¬é“¾æ¥
          echo "containerd=$(latest containerd.io)" >> "$GITHUB_OUTPUT"
          echo "docker_ce=$(latest docker-ce)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_cli=$(latest docker-ce-cli)" >> "$GITHUB_OUTPUT"
          echo "docker_buildx_plugin=$(latest docker-buildx-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_compose_plugin=$(latest docker-compose-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_rootless_extras=$(latest docker-ce-rootless-extras)" >> "$GITHUB_OUTPUT"

      - name: Download CentOS packages
        run: |
          set -euo pipefail
          ARCH=$(uname -m)
          PKG_DIR="centos-stream-${{ env.CENTOS_STREAM_VER }}-$ARCH"
          mkdir -p "$PKG_DIR"
          cd "$PKG_DIR"

          # ä¸‹è½½æ‰€æœ‰åŒ…
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.containerd }}" -o "containerd.io.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce }}" -o "docker-ce.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce_cli }}" -o "docker-ce-cli.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_buildx_plugin }}" -o "docker-buildx-plugin.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_compose_plugin }}" -o "docker-compose-plugin.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce_rootless_extras }}" -o "docker-ce-rootless-extras.rpm"

      - name: Upload CentOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: $PKG_DIR
          path: $PKG_DIR

  release:
    needs: [ubuntu-noble, centos-stream-9]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: pkgs

      - name: Create zip archives
        run: |
          set -euo pipefail
          cd pkgs
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done

      - name: Generate release tag
        id: tag
        run: echo "RELEASE_TAG=docker-packages-$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          name: Docker Packages ${{ steps.tag.outputs.RELEASE_TAG }}
          body: |
            ğŸ“¦ è‡ªåŠ¨åŒ–æ„å»ºçš„ Docker æœ€æ–°åŒ…é›†åˆï¼š
            
            - **Ubuntu {{ env.UBUNTU_CODENAME }}** (Architecture: ${{ steps.ubuntu-noble.outputs.ARCH }})
            - **CentOS Stream {{ env.CENTOS_STREAM_VER }}** (Architecture: ${{ steps.centos-stream-9.outputs.ARCH }})
            
            åŒ…å«ç»„ä»¶ï¼š
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            - docker-ce-rootless-extras (ä»… CentOS)

          files: |
            pkgs/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
