name: Fetch Latest Docker Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

env:
  UBUNTU_CODENAME: noble
  CENTOS_STREAM_VER: 9

jobs:
  # ...ï¼ˆubuntu-noble å’Œ centos-stream-9 job ä¿æŒä¸å˜ï¼‰...

  release:
    needs: [ubuntu-noble, centos-stream-9]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: pkgs

      - name: Verify downloaded files
        run: ls -lR pkgs

      - name: Create zip archives
        run: |
          set -euo pipefail
          cd pkgs || exit
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done

      - name: Generate release tag
        id: tag
        run: echo "RELEASE_TAG=docker-packages-$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          name: Docker Packages ${{ steps.tag.outputs.RELEASE_TAG }}
          body: |
            ğŸ“¦ è‡ªåŠ¨åŒ–æ„å»ºçš„ Docker æœ€æ–°åŒ…é›†åˆï¼š
            
            - **Ubuntu {{ env.UBUNTU_CODENAME }}** (Architecture: ${{ steps.ubuntu-noble.outputs.ARCH }})
            - **CentOS Stream {{ env.CENTOS_STREAM_VER }}** (Architecture: ${{ steps.centos-stream-9.outputs.ARCH }})
            
            åŒ…å«ç»„ä»¶ï¼š
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            - docker-ce-rootless-extras (ä»… CentOS)

          files: |
            pkgs/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
