name: Fetch Latest Docker Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # 每天 02:00 UTC 自动运行（可按需调整）

permissions:
  contents: write # 允许创建 Release 与上传资产

env:
  UBUNTU_CODENAME: noble   # Ubuntu 24.04
  CENTOS_STREAM_VER: 9     # CentOS Stream 9

jobs:
  ubuntu-noble:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq

      - name: Fetch latest .deb URLs for Ubuntu ${{ env.UBUNTU_CODENAME }}
        id: ubuntu_urls
        run: |
          set -euo pipefail
          ARCH=$(dpkg --print-architecture) # amd64|arm64
          BASE="https://download.docker.com/linux/ubuntu/dists/${{ env.UBUNTU_CODENAME }}/pool/stable/$ARCH"
          echo "BASE=$BASE" >> "$GITHUB_OUTPUT"

          # 索引页解析出各包的最新版本目录（按文件名排序取最新）
          latest() {
            curl -fsSL "$BASE/" \
              | grep -oP 'href="\K[^"]+'"$1"'(?=_'"$ARCH"'\.deb)' \
              | sort -Vr | head -n1
          }

          echo "containerd=$(latest containerd.io)" >> "$GITHUB_OUTPUT"
          echo "docker_ce=$(latest docker-ce)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_cli=$(latest docker-ce-cli)" >> "$GITHUB_OUTPUT"
          echo "docker_buildx_plugin=$(latest docker-buildx-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_compose_plugin=$(latest docker-compose-plugin)" >> "$GITHUB_OUTPUT"

      - name: Download Ubuntu packages
        run: |
          set -euo pipefail
          mkdir -p "ubuntu-${{ env.UBUNTU_CODENAME }}-$ARCH"
          cd "ubuntu-${{ env.UBUNTU_CODENAME }}-$ARCH"

          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.containerd }}" -o "containerd.io_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_ce }}" -o "docker-ce_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_ce_cli }}" -o "docker-ce-cli_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_buildx_plugin }}" -o "docker-buildx-plugin_${ARCH}.deb"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.ubuntu_urls.outputs.docker_compose_plugin }}" -o "docker-compose-plugin_${ARCH}.deb"

      - name: Upload Ubuntu artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ env.UBUNTU_CODENAME }}-$ARCH
          path: ubuntu-${{ env.UBUNTU_CODENAME }}-$ARCH

  centos-stream-9:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl jq rpm2cpio cpio

      - name: Fetch latest .rpm URLs for CentOS Stream ${{ env.CENTOS_STREAM_VER }}
        id: centos_urls
        run: |
          set -euo pipefail
          ARCH=$(uname -m) # x86_64|aarch64
          BASE="https://download.docker.com/linux/centos/${{ env.CENTOS_STREAM_VER }}/$ARCH/stable/Packages"
          echo "BASE=$BASE" >> "$GITHUB_OUTPUT"

          # 索引页解析出各包的最新版本（按文件名排序取最新）
          latest() {
            curl -fsSL "$BASE/" \
              | grep -oP 'href="\K[^"]+'"$1"'(?-\d+\.'"$ARCH"'\.rpm)' \
              | sort -Vr | head -n1
          }

          echo "containerd=$(latest containerd.io)" >> "$GITHUB_OUTPUT"
          echo "docker_ce=$(latest docker-ce)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_cli=$(latest docker-ce-cli)" >> "$GITHUB_OUTPUT"
          echo "docker_buildx_plugin=$(latest docker-buildx-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_compose_plugin=$(latest docker-compose-plugin)" >> "$GITHUB_OUTPUT"
          echo "docker_ce_rootless_extras=$(latest docker-ce-rootless-extras)" >> "$GITHUB_OUTPUT"

      - name: Download CentOS Stream packages
        run: |
          set -euo pipefail
          mkdir -p "centos-stream-${{ env.CENTOS_STREAM_VER }}-$ARCH"
          cd "centos-stream-${{ env.CENTOS_STREAM_VER }}-$ARCH"

          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.containerd }}" -o "containerd.io.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce }}" -o "docker-ce.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce_cli }}" -o "docker-ce-cli.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_buildx_plugin }}" -o "docker-buildx-plugin.rpm"
          curl -fsSL "${{ steps.ubuntu_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_compose_plugin }}" -o "docker-compose-plugin.rpm"
          curl -fsSL "${{ steps.centos_urls.outputs.BASE }}/${{ steps.centos_urls.outputs.docker_ce_rootless_extras }}" -o "docker-ce-rootless-extras.rpm"

      - name: Upload CentOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: centos-stream-${{ env.CENTOS_STREAM_VER }}-$ARCH
          path: centos-stream-${{ env.CENTOS_STREAM_VER }}-$ARCH

  release:
    needs: [ubuntu-noble, centos-stream-9]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: pkgs

      - name: Create zip per system
        run: |
          set -euo pipefail
          cd pkgs
          for d in */; do
            zip -r "${d%/}.zip" "$d"
          done

      - name: Generate release tag
        id: tag
        run: echo "TAG=docker-packages-$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          name: Docker Packages ${{ steps.tag.outputs.TAG }}
          body: |
            Auto-collected latest Docker packages for:
            - Ubuntu **${{ env.UBUNTU_CODENAME }}** (${{ steps.ubuntu-noble.outputs.ARCH }})
            - CentOS Stream **${{ env.CENTOS_STREAM_VER }}** (${{ steps.centos-stream-9.outputs.ARCH }})
          files: |
            pkgs/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
