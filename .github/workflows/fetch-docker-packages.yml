name: Fetch Latest Docker Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤© 02:00 UTC è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„äº§

env:
  UBUNTU_CODENAME: noble   # Ubuntu 24.04
  CENTOS_STREAM_VER: 9     # CentOS Stream 9

jobs:
  # ...ï¼ˆubuntu-noble å’Œ centos-stream-9 job ä¿æŒä¸å˜ï¼‰...

  release:
    needs: [ubuntu-noble, centos-stream-9]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ github.workspace }}/pkgs

      - name: Verify downloaded files
        run: |
          ls -lR ${{ github.workspace }}/pkgs
          if [ ! -d "${{ github.workspace }}/pkgs/ubuntu-${{ env.UBUNTU_CODENAME }}-amd64" ]; then
            echo "Error: Ubuntu package directory not found" >&2
            exit 1
          fi
          if [ ! -d "${{ github.workspace }}/pkgs/centos-stream-${{ env.CENTOS_STREAM_VER }}-x86_64" ]; then
            echo "Error: CentOS package directory not found" >&2
            exit 1
          fi

      - name: Create zip archives
        run: |
          set -euo pipefail
          cd ${{ github.workspace }}/pkgs || exit

          pushd "ubuntu-${{ env.UBUNTU_CODENAME }}-amd64" >/dev/null
          zip -r "ubuntu-${{ env.UBUNTU_CODENAME }}-amd64.zip" ./*
          popd >/dev/null

          pushd "centos-stream-${{ env.CENTOS_STREAM_VER }}-x86_64" >/dev/null
          zip -r "centos-stream-${{ env.CENTOS_STREAM_VER }}-x86_64.zip" ./*
          popd >/dev/null

      - name: Generate release tag
        id: tag
        run: echo "RELEASE_TAG=docker-packages-$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          name: Docker Packages ${{ steps.tag.outputs.RELEASE_TAG }}
          body: |
            ğŸ“¦ è‡ªåŠ¨åŒ–æ„å»ºçš„ Docker æœ€æ–°åŒ…é›†åˆï¼š
            
            - **Ubuntu {{ env.UBUNTU_CODENAME }}** (Architecture: amd64)
            - **CentOS Stream {{ env.CENTOS_STREAM_VER }}** (Architecture: x86_64)
            
            åŒ…å«ç»„ä»¶ï¼š
            - containerd.io
            - docker-ce
            - docker-ce-cli
            - docker-buildx-plugin
            - docker-compose-plugin
            - docker-ce-rootless-extras (ä»… CentOS)

          files: |
            ${{ github.workspace }}/pkgs/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
